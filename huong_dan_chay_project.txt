# H∆∞·ªõng D·∫´n Ch·∫°y Project Xe V√µ C√∫c Ph∆∞∆°ng

## M·ª•c L·ª•c
- [1. C√†i ƒê·∫∑t Dependencies](#1-c√†i-ƒë·∫∑t-dependencies)
- [2. C·∫•u H√¨nh Database v·ªõi Prisma](#2-c·∫•u-h√¨nh-database-v·ªõi-prisma)
- [3. C·∫•u H√¨nh Casso Webhook](#3-c·∫•u-h√¨nh-casso-webhook)
- [4. Ch·∫°y D·ª± √Ån](#4-ch·∫°y-d·ª±-√°n)
- [5. C√°c L·ªánh H·ªØu √çch](#5-c√°c-l·ªánh-h·ªØu-√≠ch)

---

## 1. C√†i ƒê·∫∑t Dependencies

### B∆∞·ªõc 1.1: C√†i ƒë·∫∑t Node.js packages
```bash
npm install
```

---

## 2. C·∫•u H√¨nh Database v·ªõi Prisma

### B∆∞·ªõc 2.1: T·∫°o file `.env`
T·∫°o file `.env` trong th∆∞ m·ª•c g·ªëc c·ªßa project v√† th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng:

```bash
# ==================================
# DATABASE
# ==================================
DATABASE_URL="postgres://e260aa1dc7ec523d063ad4793798704a28518eac3afe44661640d7d7659315ce:sk_Q8NoTIdR6Powx9IjYDVAL@db.prisma.io:5432/postgres?sslmode=require"

# ==================================
# NEXTAUTH
# ==================================
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-super-secret-key-change-this-in-production"

# ==================================
# EMAIL SERVICE (Nodemailer v·ªõi Gmail)
# ==================================
EMAIL_HOST="smtp.gmail.com"
EMAIL_PORT="587"
EMAIL_USER="vocucphuong0018@gmail.com"
EMAIL_PASSWORD="your-gmail-app-password"
EMAIL_FROM="Xe V√µ C√∫c Ph∆∞∆°ng <vocucphuong0018@gmail.com>"

# ==================================
# APP CONFIG
# ==================================
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_COMPANY_NAME="Xe V√µ C√∫c Ph∆∞∆°ng"
NEXT_PUBLIC_COMPANY_PHONE="02519999975"
NEXT_PUBLIC_COMPANY_EMAIL="vocucphuong0018@gmail.com"

# ==================================
# BANK ACCOUNT (for VietQR)
# ==================================
BANK_ACCOUNT_NO="your-bank-account-number"
BANK_ACCOUNT_NAME="YOUR BANK ACCOUNT NAME"
BANK_CODE="970422"

# ==================================
# CASSO WEBHOOK
# ==================================
CASSO_API_KEY="3lXYi6CY1N63XAzbDXjfF7YKqD70PZ4Fr0ZQGUNOgV6k592OtGALwT1vaKos5I9V"
CASSO_WEBHOOK_URL="https://d6e3cb57a6fd.ngrok-free.app/webhook/casso"
```

### B∆∞·ªõc 2.2: Generate Prisma Client
```bash
npx dotenv -e .env -- npx prisma generate
```

### B∆∞·ªõc 2.3: Pull Database Schema (n·∫øu database ƒë√£ t·ªìn t·∫°i)
```bash
npx dotenv -e .env -- npx prisma db pull
```

**HO·∫∂C** Ch·∫°y Migration ƒë·ªÉ t·∫°o Database Schema m·ªõi:
```bash
npx dotenv -e .env -- npx prisma migrate dev --name init
```

L·ªánh n√†y s·∫Ω:
- T·∫°o c√°c b·∫£ng trong database theo schema ƒë√£ ƒë·ªãnh nghƒ©a
- T·∫°o migration history
- Generate Prisma Client m·ªõi

### B∆∞·ªõc 2.4: (T√πy ch·ªçn) Seed d·ªØ li·ªáu m·∫´u
```bash
npx dotenv -e .env -- npx prisma db seed
```

### B∆∞·ªõc 2.5: Xem Database v·ªõi Prisma Studio
```bash
npx dotenv -e .env -- npx prisma studio
```
Truy c·∫≠p: http://localhost:5555 ƒë·ªÉ xem v√† qu·∫£n l√Ω database tr·ª±c quan.

---

## 3. C·∫•u H√¨nh Casso Webhook

### B∆∞·ªõc 3.1: T·∫°o API Route cho Webhook

T·∫°o file `src/app/api/webhook/casso/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// Verify Casso webhook signature
function verifyCassoSignature(body: any, apiKey: string): boolean {
  // Implement signature verification logic here
  // Casso s·∫Ω g·ª≠i k√®m signature ƒë·ªÉ verify request
  return true; // Placeholder
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();

    // Verify webhook t·ª´ Casso
    const apiKey = process.env.CASSO_API_KEY;
    if (!apiKey || !verifyCassoSignature(body, apiKey)) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    // Log webhook data
    console.log('Casso Webhook received:', JSON.stringify(body, null, 2));

    // Parse th√¥ng tin giao d·ªãch t·ª´ Casso
    const {
      id,              // Transaction ID t·ª´ Casso
      amount,          // S·ªë ti·ªÅn
      description,     // N·ªôi dung chuy·ªÉn kho·∫£n
      when,            // Th·ªùi gian giao d·ªãch
      bank_sub_acc_id  // ID t√†i kho·∫£n ng√¢n h√†ng
    } = body.data || body;

    // T√¨m booking code trong description
    // V√≠ d·ª•: "NAP TIEN VE VCP123456"
    const bookingCodeMatch = description?.match(/VCP[A-Z0-9]+/i);

    if (!bookingCodeMatch) {
      console.log('Kh√¥ng t√¨m th·∫•y m√£ booking trong n·ªôi dung CK');
      return NextResponse.json({
        success: false,
        message: 'Kh√¥ng t√¨m th·∫•y m√£ booking'
      });
    }

    const bookingCode = bookingCodeMatch[0].toUpperCase();
    console.log('T√¨m th·∫•y booking code:', bookingCode);

    // T√¨m booking trong database
    const booking = await prisma.booking.findUnique({
      where: { bookingCode },
      include: { payment: true }
    });

    if (!booking) {
      console.log('Kh√¥ng t√¨m th·∫•y booking:', bookingCode);
      return NextResponse.json({
        success: false,
        message: 'Kh√¥ng t√¨m th·∫•y booking'
      });
    }

    // Ki·ªÉm tra s·ªë ti·ªÅn c√≥ kh·ªõp kh√¥ng
    if (Math.abs(booking.totalPrice - amount) > 1000) {
      console.log('S·ªë ti·ªÅn kh√¥ng kh·ªõp:', { expected: booking.totalPrice, received: amount });
      return NextResponse.json({
        success: false,
        message: 'S·ªë ti·ªÅn kh√¥ng kh·ªõp'
      });
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i payment
    if (booking.payment) {
      await prisma.payment.update({
        where: { id: booking.payment.id },
        data: {
          status: 'COMPLETED',
          transactionId: String(id),
          paidAt: new Date(when),
          metadata: body
        }
      });
    } else {
      // T·∫°o payment m·ªõi n·∫øu ch∆∞a c√≥
      await prisma.payment.create({
        data: {
          bookingId: booking.id,
          amount: amount,
          method: 'BANK_TRANSFER',
          status: 'COMPLETED',
          transactionId: String(id),
          paidAt: new Date(when),
          metadata: body
        }
      });
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i booking
    await prisma.booking.update({
      where: { id: booking.id },
      data: {
        status: 'PAID'
      }
    });

    console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t thanh to√°n th√†nh c√¥ng cho booking:', bookingCode);

    // TODO: G·ª≠i email x√°c nh·∫≠n ƒë√£ thanh to√°n
    // TODO: G·ª≠i SMS x√°c nh·∫≠n ƒë√£ thanh to√°n

    return NextResponse.json({
      success: true,
      message: 'Payment updated successfully',
      bookingCode
    });

  } catch (error) {
    console.error('L·ªói x·ª≠ l√Ω Casso webhook:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

// Allow GET for testing
export async function GET() {
  return NextResponse.json({
    message: 'Casso Webhook endpoint is working',
    timestamp: new Date().toISOString()
  });
}
```

### B∆∞·ªõc 3.2: C√†i ƒë·∫∑t Ngrok (ƒë·ªÉ test webhook tr√™n local)

```bash
# C√†i ƒë·∫∑t ngrok
brew install ngrok  # macOS
# ho·∫∑c t·∫£i t·∫°i: https://ngrok.com/download

# Ch·∫°y ngrok ƒë·ªÉ expose local server
ngrok http 3000
```

Ngrok s·∫Ω cung c·∫•p URL d·∫°ng: `https://abc123.ngrok-free.app`

### B∆∞·ªõc 3.3: C·∫•u h√¨nh Webhook tr√™n Casso

1. ƒêƒÉng nh·∫≠p v√†o [Casso.vn](https://casso.vn)
2. V√†o **C√†i ƒë·∫∑t** ‚Üí **Webhook**
3. Th√™m webhook URL: `https://abc123.ngrok-free.app/api/webhook/casso`
4. Nh·∫≠p API Key: `3lXYi6CY1N63XAzbDXjfF7YKqD70PZ4Fr0ZQGUNOgV6k592OtGALwT1vaKos5I9V`
5. Ch·ªçn c√°c s·ª± ki·ªán c·∫ßn nh·∫≠n:
   - ‚úÖ Nh·∫≠n ti·ªÅn v√†o t√†i kho·∫£n
6. L∆∞u c·∫•u h√¨nh

### B∆∞·ªõc 3.4: Test Webhook

Test b·∫±ng c√°ch chuy·ªÉn kho·∫£n v·ªõi n·ªôi dung c√≥ m√£ booking:
```
NAP TIEN VE VCP123456
```

Ki·ªÉm tra logs:
```bash
# Xem logs c·ªßa Next.js server
# Payment s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi c√≥ giao d·ªãch
```

---

## 4. Ch·∫°y D·ª± √Ån

### Development Mode
```bash
npm run dev
```
Website ch·∫°y t·∫°i: http://localhost:3000

### Production Mode
```bash
# Build project
npm run build

# Start production server
npm start
```

---

## 5. C√°c L·ªánh H·ªØu √çch

### Prisma Commands

**L∆∞u √Ω:** T·∫•t c·∫£ l·ªánh Prisma c·∫ßn d√πng `npx dotenv -e .env --` ƒë·ªÉ load bi·∫øn m√¥i tr∆∞·ªùng.

```bash
# Generate Prisma Client (sau khi thay ƒë·ªïi schema)
npx dotenv -e .env -- npx prisma generate

# Pull schema t·ª´ database (sync v·ªõi DB hi·ªán t·∫°i)
npx dotenv -e .env -- npx prisma db pull

# T·∫°o migration m·ªõi
npx dotenv -e .env -- npx prisma migrate dev --name ten_migration

# Deploy migrations l√™n production
npx dotenv -e .env -- npx prisma migrate deploy

# Reset database (X√ìA T·∫§T C·∫¢ D·ªÆ LI·ªÜU!)
npx dotenv -e .env -- npx prisma migrate reset

# M·ªü Prisma Studio
npx dotenv -e .env -- npx prisma studio

# Format schema file
npx dotenv -e .env -- npx prisma format

# Validate schema
npx dotenv -e .env -- npx prisma validate

# Seed database
npx dotenv -e .env -- npx prisma db seed
```

### Development Commands

```bash
# Ch·∫°y dev server
npm run dev

# Build project
npm run build

# Start production server
npm start

# Run linter
npm run lint

# Check TypeScript errors
npx tsc --noEmit
```

### Git Commands

```bash
# Xem status
git status

# Add files
git add .

# Commit
git commit -m "Your message"

# Push
git push
```

---

## 6. Ki·ªÉm Tra H·ªá Th·ªëng

### Test Database Connection
```bash
npx prisma db pull
```

### Test API Endpoints
```bash
# Test webhook endpoint
curl http://localhost:3000/api/webhook/casso

# Test booking API
curl http://localhost:3000/api/bookings/check-status
```

### Ki·ªÉm tra Logs
- Development: Xem console c·ªßa terminal ƒëang ch·∫°y `npm run dev`
- Production: Xem logs c·ªßa hosting service (Vercel, Railway, etc.)

---

## 7. Troubleshooting

### L·ªói Database Connection
```bash
# Ki·ªÉm tra DATABASE_URL trong .env
# Ch·∫°y l·∫°i generate v√† migrate
npx prisma generate
npx prisma migrate dev
```

### L·ªói Webhook kh√¥ng nh·∫≠n ƒë∆∞·ª£c
- Ki·ªÉm tra ngrok ƒëang ch·∫°y: `curl https://your-ngrok-url.ngrok-free.app/api/webhook/casso`
- Ki·ªÉm tra API Key Casso ƒë√∫ng ch∆∞a
- Xem logs c·ªßa Next.js server ƒë·ªÉ debug

### L·ªói Build
```bash
# Clear cache v√† rebuild
rm -rf .next
rm -rf node_modules
npm install
npm run build
```

---

## 8. Deploy Production

### Deploy l√™n Vercel (Recommended)

1. Push code l√™n GitHub
2. Import project v√†o [Vercel](https://vercel.com)
3. Add Environment Variables (copy t·ª´ .env)
4. Deploy

### C·∫≠p nh·∫≠t Webhook URL sau khi deploy
- URL m·ªõi: `https://your-domain.vercel.app/api/webhook/casso`
- C·∫≠p nh·∫≠t l·∫°i webhook URL tr√™n Casso.vn

---

## Li√™n H·ªá & H·ªó Tr·ª£

- Email: vocucphuong0018@gmail.com
- Phone: 02519999975

---

**Ch√∫c b·∫°n ch·∫°y project th√†nh c√¥ng!** üöÄ
